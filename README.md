# AI Auto Mail System

AI Auto Mail System は、`info@` のような共有メールアドレスに届いた問い合わせへ、Gemini 2.5 Flash を活用して人間らしい返信ドラフトを生成し、承認フローと自動送信の両方に対応できるプラットフォームです。

## ビジョン

- 迅速な対応と人間味のある応対を両立させ、顧客体験を向上させる。
- オペレーターの承認 UI を標準としつつ、完全自動送信モードも選べる柔軟さを提供する。
- メール文面、PDF、スクリーンショット、スプレッドシートなど社内ナレッジを集約し、AI が一貫したトーンで回答できる基盤を整備する。

## コア機能

- 参考文面のアップロード（メール履歴、PDF、画像、ドキュメントなど）とメタデータ管理。
- Google スプレッドシートなど構造化ナレッジとの同期（製品情報、FAQ、エスカレーションルール等）。
- LLM（Gemini 2.5 Flash）による返信ドラフト生成と、トーン・敬語の調整。
- `承認` ボタン付きの人間の確認フローと、ワンクリックで切り替えられる自動送信モード。
- 返信元アドレス／署名の選択・テンプレート化（ユーザー単位・受信箱単位の設定を想定）。

## 体験フロー

1. **受信**: IMAP/POP3 のポーリング、Webhook、メール転送などで問い合わせを取り込み。
2. **ドラフト生成**: 取得した文面とアップロード済みナレッジを組み合わせ、AI が返信案を作成。
3. **レビュー（既定）**: オペレーターが通知を受け、ドラフトを確認・微修正し `承認` を押して送信。
4. **自動送信（任意）**: 自動送信モードが有効なスレッドは、レビューをスキップして即時送信。全履歴は監査ログに保存。

## ハイレベル・アーキテクチャ

- **メール連携レイヤー**  
  Google Workspace（Gmail API）、Microsoft 365（Graph API）、汎用 IMAP/SMTP（例: Xserver）、外部送信サービス（SendGrid/Mailgun/AWS SES など）をアダプタとして拡張できる設計。

- **ナレッジ管理**  
  - 参考資料ファイルの保管とバージョン管理。  
  - Google スプレッドシート API を介した構造化データ取得。  
  - 必要に応じてベクトル DB を導入し、検索結果をプロンプトに注入。

- **AI ドラフティングサービス**  
  - 問い合わせ内容、関連ナレッジ、トーン設定を統合したプロンプトを生成。  
  - Gemini 2.5 Flash を標準実装しつつ、LLM 抽象レイヤーで将来のモデル差し替えも考慮。  
  - サンプルメールやトーン定義をプロンプトに組み込み、表現の一貫性を担保。

- **ワークフロー & 承認エンジン**  
  - ステータス管理（`drafting`、`awaiting approval`、`sent`、`auto-sent` など）。  
  - 承認ルール、自動送信切り替え、権限チェック。  
  - プロンプト、ドラフト、編集履歴、送信イベントの監査ログを保持。

- **Web アプリケーション**  
  - 受信一覧、ドラフト、承認待ちを確認するダッシュボード。  
  - 参考資料アップロード UI。  
  - 差出人アドレス、署名、自動送信ポリシー、ナレッジ連携の設定画面。

- **通知 & 配信**  
  - 承認が必要な場合のメール / SMS / プッシュ通知。  
  - DKIM/SPF 整合性を考慮した SMTP 送信。  
  - バウンス検知と再送制御。

## 設定とカスタマイズ

- **送信元プロファイル**: 複数の `From` アドレスと表示名、署名テンプレートを保存し、問い合わせごとに切り替え。
- **署名管理**: テキスト/HTML 署名を管理し、担当者名や連絡先を差し込む変数に対応。
- **ナレッジ同期**: スプレッドシートの定期同期や手動更新トリガーを用意。
- **自動送信ポリシー**: 全体設定・受信箱単位設定・AI 信頼度しきい値などで制御。
- **監査ログ**: 送信前後の文面、承認者、通知履歴を保存し、コンプライアンスやトラブルシュートに対応。

## セキュリティとコンプライアンス

- アップロード、設定変更、承認といった権限をロールベースで制御。
- ナレッジ資産やドラフトは暗号化して保存。
- メール、スプレッドシート、LLM 連携の OAuth 資格情報を安全に管理。
- 不審なアクティビティや送信失敗を検知し、通知と記録を行う。

## Google Workspace 向け MVP（Apps Script）

Google 生态内で迅速に試作する最小構成:

1. **Gmail ラベル & トリガー**
   - `info@` 宛メールに `INFO_INBOX` ラベルを自動付与（Gmail フィルタ）。  
   - Apps Script の時間主導トリガー（1〜5 分ごと）でラベル付きスレッドを巡回。
2. **ナレッジ取得**
   - Google スプレッドシート `Knowledge` シートに key / content / tags を保存。  
   - Google ドライブ上のドキュメントを読み込み、トーンやガイドラインを抽出。
3. **ドラフト生成**
   - 問い合わせとナレッジを整形し、Gemini 2.5 Flash に `UrlFetchApp` でリクエスト。  
   - 生成文は Gmail の下書きに保存し、`Pending` シートにスレッド ID・信頼度などを記録。
4. **承認 & 送信**
   - スプレッドシートにカスタムメニュー「承認して送信」を追加し、選択行を GmailApp で送信。  
   - 送信後は `Logs` シートへ移動し、監査ログを更新。  
   - 自動送信フラグがオンの案件は下書きを経由せず即送信。
5. **設定管理**
   - `Settings` シートで差出人アドレス、署名、自動送信ポリシーを管理。  
   - ステータス遷移や送信結果を記録し、後から参照できるようにする。

この MVP により、構築コストを抑えつつワークフローを検証し、その後マルチプロバイダ構成へ段階的に拡張できる。

## 一般ユーザー向けオンボーディング案

- **ステップガイド付きウィザード**  
  0. アカウント登録後のメール認証（ワンタイムリンクで有効化）。  
  1. メールプロバイダ選択（Gmail / Microsoft 365 / IMAP・SMTP）。  
  2. 参考文面や資料のアップロード。  
  3. スプレッドシート連携（OAuth 認可 → テンプレートコピー）。  
  4. 差出人・署名・自動送信ポリシー設定。  
  5. テスト送信で完了確認。
- **自動設定**: OAuth 承認後、必要なラベル・フィルタ・Webhook・トリガーを自動作成。
- **IMAP/SMTP 対応**: Xserver 等の独自ドメイン利用者向けに、接続情報入力で検証できるフォームと SPF/DKIM チェックリストを提供。
- **プリセット提供**: トーンプリセット、署名テンプレート、FAQ シートなどをワンクリックで導入。

## フロントエンド UI プロトタイプ

Netlify へのデプロイを想定した React + Vite（TypeScript）の UI プロトタイプを `frontend/` に配置しています。受信メール一覧と本文プレビュー（ポップアップ表示）、AI 返信編集、送信フローをひとつの画面で確認できるほか、手動同期ボタン、メールファイルのドラッグ＆ドロップ入力、ワンクリック翻訳／要約、そして「受信設定」タブでの転送／IMAP 情報管理に対応しています。ヘッダーの `Admin` リンクからは管理コンソール（Gemini 設定・プロンプト編集・ユーザー管理）へ遷移できます。

ヘッダーの「システム設定」から、ナレッジ用スプレッドシートリンク、参考メールアップロード（ドラッグ＆ドロップ）、承認通知メールアドレス、出力言語、担当者氏名・署名および反映有無など運用に必要な項目を入力できます。ユーザー情報保存用スプレッドシートや Gemini API キー、自動送信しきい値、プロンプト設定などは管理ページ（Admin）で管理します。

Admin コンソールでは、Gemini API キーと自動送信しきい値、システム／フォールバックプロンプトの管理に加え、ユーザーアカウント情報（氏名・メール・電話・住所・役割）の編集／追加／削除と、ユーザーデータ保存先スプレッドシートの設定が行えます。

### ローカル起動手順

```bash
cd frontend
npm install
npm run dev
```

ブラウザで `http://localhost:5173` にアクセスするとレビュー画面が表示されます。現在はダミーデータで動作しているため、実装を進める際はバックエンド/API との接続を置き換えてください。

### Netlify デプロイ設定メモ

- **Base directory**: `frontend`
- **Build command**: `npm run build`
- **Publish directory**: `dist`

環境変数や API エンドポイントが追加された場合は Netlify 側の Build settings → Environment variables に登録します。

## オープン課題と次のステップ

- 主要メールプロバイダ（Gmail、Microsoft 365、Xserver 等）の優先順位と対応方法の確定。  
- Graph API や汎用 IMAP アダプタなど、マルチプロバイダ対応インターフェースの設計。  
- バックエンド技術スタック（例: Node.js/TypeScript）とデプロイ戦略の決定。  
- 日本語・英語などマルチリンガル対応とトーンプリセットの定義。  
- ダッシュボード／オンボーディング UI のワイヤーフレーム作成。  
- メール認証フロー（トークン発行・期限管理・再送制御）と MVP マイルストーン（受信→ドラフト→承認→自動送信）を含むテスト計画の策定。

今後の議論や実装内容に応じて README を更新していきます。
